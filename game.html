<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mini Militia Web - War Room</title>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: monospace; color: white; }
        #ui-layer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        #status-panel {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.6); padding: 10px; border: 1px solid #555; pointer-events: auto;
            min-width: 220px; border-radius: 8px;
        }
        .green { color: #2ecc71; font-weight: bold; } 
        .red { color: #e74c3c; } 
        .blue { color: #3498db; } 
        .yellow { color: #f1c40f; } 
        .orange { color: #e67e22; }

        #deploy-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #222; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }
        #deploy-btn {
            font-size: 2rem; padding: 20px 40px; background: #27ae60; 
            color: white; border: none; cursor: pointer; pointer-events: auto;
            border-bottom: 5px solid #1e8449; border-radius: 5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        #loading-text { display: none; margin-top: 15px; color: #aaa; font-size: 14px; }

        .coord-box { margin-top: 10px; border-top: 1px solid #555; padding-top: 5px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="deploy-screen">
        <button id="deploy-btn">DEPLOY SOLDIER</button>
        <div id="loading-text">ESTABLISHING UPLINK...</div>
    </div>

    <div id="ui-layer">
        <div id="status-panel">
            <div>ME: <span id="disp-id" class="yellow">...</span></div>
            <div>ROLE: <span id="disp-role">ASSIGNING...</span></div>
            <div>STATUS: <span id="disp-status" class="red">INITIALIZING</span></div>
            
            <div class="coord-box">
                <div>MY POS: <span id="my-coords" class="green">0, 0</span></div>
                <div>ENEMY: <span id="enemy-coords" class="red">WAITING...</span></div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS ---
        import { startNetwork, broadcastData } from "./webrtc.js";
        import { initGame, handleNetworkData, handlePeerDisconnect, getPlayerPosition } from "./gameloop.js";

        // --- SESSION ---
        const sessionRaw = localStorage.getItem('mm_session');
        if (!sessionRaw) window.location.href = "index.html";
        const session = JSON.parse(sessionRaw);
        
        document.getElementById('disp-id').innerText = session.name;

        // --- 1. START TRIGGER ---
        const deployBtn = document.getElementById('deploy-btn');
        deployBtn.addEventListener('click', async () => {
            deployBtn.style.display = 'none';
            document.getElementById('loading-text').style.display = 'block';

            try { if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen(); } catch(e) {}

            document.getElementById('deploy-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';

            // Start Systems
            startNetwork(session.room, session.id, session.name);
            initGame();
        });

        // --- 2. CONNECTING THE MODULES ---
        
        // When WebRTC receives data, pass it to Game Loop
        window.onNetworkData = (id, data) => {
            handleNetworkData(id, data);
        };

        // When WebRTC says a peer dropped, tell Game Loop to remove sprite
        window.onPeerDisconnect = (id) => {
            handlePeerDisconnect(id);
        };

        // When WebRTC connects, grab current player pos from Game Loop and send it immediately
        window.onNetworkConnect = () => {
            setTimeout(() => {
                const pos = getPlayerPosition();
                if(pos) broadcastData(pos);
            }, 500);
        };

    </script>
</body>
</html>
