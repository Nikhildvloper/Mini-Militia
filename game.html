<!DOCTYPE html>
<html>
<head>
  <title>Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- SAME STYLES AS BEFORE --- */
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #000; font-family: Arial, sans-serif; }
    #videoContainer { position: relative; width: 100vw; height: 100vh; background: black; }
    #remoteVideo { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100vw; height: 100vh; object-fit: contain; z-index: 1; }
    #localVideo { position: absolute; bottom: 10%; right: 10%; height: 180px; width: auto; object-fit: contain; border-radius: 12px; border: 2px solid #fff; z-index: 3; background-color: black; }
    #endCall { position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); background: transparent; border: none; cursor: pointer; z-index: 4; width: 70px; height: 70px; }
    #endCall img { width: 100%; height: 100%; object-fit: contain; }
    #switchCamera { position: absolute; bottom: 10%; right: 40%; z-index: 4; width: 50px; height: 50px; background: rgba(255,255,255,0.15); border: none; border-radius: 50%; color: #fff; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #videoQuality { position: absolute; bottom: 10%; left: 40px; z-index: 4; background: rgba(255,255,255,0.15); color: #fff; border: none; font-size: 16px; border-radius: 8px; padding: 6px 12px; cursor: pointer; }
    #roomIdDisplay { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0, 0, 0, 0.5); padding: 8px 16px; border-radius: 12px; font-size: 16px; z-index: 5; }
    #statusOverlay { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); color: #4CAF50; font-weight: bold; z-index: 5; text-shadow: 1px 1px 0 #000; }
  </style>
</head>
<body>
  <div id="videoContainer">
    <div id="roomIdDisplay">Room: Loading...</div>
    <div id="statusOverlay">Connecting...</div>
    
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
    
    <button id="endCall"><img src="https://img.icons8.com/ios-filled/50/ff0000/end-call-male.png" alt="End"></button>
    <button id="switchCamera" title="Switch Camera">&#8645;</button>
    
    <select id="videoQuality">
      <option value="low" selected>Low</option>
      <option value="sd">SD</option>
      <option value="hd">HD</option>
    </select>
  </div>

  <script type="module">
    // Using Stable Firebase Version 10.12.2
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCRqfvB5bi8jmxNfu5zhVMcwWR0-YIM8ks",
      authDomain: "video-chat-44584.firebaseapp.com",
      projectId: "video-chat-44584",
      storageBucket: "video-chat-44584.appspot.com",
      messagingSenderId: "598757234224",
      appId: "1:598757234224:web:1ae7b1d35abafeb7d7bff5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DOM ELEMENTS ---
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const roomIdDisplay = document.getElementById('roomIdDisplay');
    const statusOverlay = document.getElementById('statusOverlay');
    
    // --- STATE ---
    // Retrieve Room ID from local storage (set by index.html) or prompt
    const roomId = localStorage.getItem('roomId') || prompt("Enter Room ID:");
    roomIdDisplay.innerText = `Room: ${roomId}`;
    
    let isInitiator = false; // We will determine this dynamically
    let localStream;
    let currentVideoDeviceId = null;
    
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    // --- 1. MEDIA SETUP ---
    async function startMedia() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            
            // Add Tracks to PC
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        } catch(e) {
            console.error("Camera Error:", e);
            alert("Could not access camera/mic.");
        }
    }

    // --- 2. SIGNALING LOGIC (AUTO-ROLE) ---
    async function joinRoom() {
        const roomRef = doc(db, 'rooms', roomId);
        const roomSnap = await getDoc(roomRef);

        if (!roomSnap.exists()) {
            // CASE 1: ROOM DOES NOT EXIST -> I AM HOST (LISTENER)
            console.log("Creating Room. I am HOST.");
            isInitiator = false;
            statusOverlay.innerText = "Waiting for Client to call...";
            
            // Create the room doc so the client can find it
            await setDoc(roomRef, { created: new Date() });
            
            // HOST LOGIC: Listen for OFFER
            onSnapshot(roomRef, async (snap) => {
                const data = snap.data();
                if (!pc.currentRemoteDescription && data && data.offer) {
                    console.log("Received OFFER from Client");
                    const offer = data.offer;
                    
                    await pc.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    
                    // Send Answer back
                    await updateDoc(roomRef, { answer: { type: answer.type, sdp: answer.sdp } });
                }
            });
            
            // Listen for ICE Candidates from Client
            listenForCandidates(roomId, 'clientCandidates');

        } else {
            // CASE 2: ROOM EXISTS -> I AM CLIENT (CALLER)
            console.log("Room found. I am CLIENT.");
            isInitiator = true;
            statusOverlay.innerText = "Calling Host...";

            // CLIENT LOGIC: Create OFFER immediately
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            // Send Offer
            await updateDoc(roomRef, { offer: { type: offer.type, sdp: offer.sdp } });

            // Listen for ANSWER
            onSnapshot(roomRef, async (snap) => {
                const data = snap.data();
                if (!pc.currentRemoteDescription && data && data.answer) {
                    console.log("Received ANSWER from Host");
                    const answer = data.answer;
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });

            // Listen for ICE Candidates from Host
            listenForCandidates(roomId, 'hostCandidates');
        }
    }

    // --- 3. ICE CANDIDATES ---
    pc.onicecandidate = async (event) => {
        if (event.candidate) {
            // If I am Initiator (Client), I write to 'clientCandidates'
            // If I am Host, I write to 'hostCandidates'
            const collectionName = isInitiator ? 'clientCandidates' : 'hostCandidates';
            const candidateCol = collection(db, 'rooms', roomId, collectionName);
            await addDoc(candidateCol, event.candidate.toJSON());
        }
    };

    function listenForCandidates(roomId, collectionName) {
        const candidateCol = collection(db, 'rooms', roomId, collectionName);
        onSnapshot(candidateCol, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    const candidate = new RTCIceCandidate(change.doc.data());
                    pc.addIceCandidate(candidate);
                }
            });
        });
    }

    // --- 4. CONNECTION EVENTS ---
    pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
        statusOverlay.innerText = "Connected";
        statusOverlay.style.color = "#00ff00";
    };

    pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'disconnected') {
            statusOverlay.innerText = "Disconnected";
            statusOverlay.style.color = "red";
        }
    };

    // --- 5. UI CONTROLS ---
    document.getElementById('endCall').onclick = async () => {
        // Simple cleanup: delete room and reload
        try { await deleteDoc(doc(db, "rooms", roomId)); } catch(e){}
        window.location.href = "index.html"; 
    };

    // --- START ---
    startMedia().then(() => {
        joinRoom();
    });

  </script>
</body>
</html>
